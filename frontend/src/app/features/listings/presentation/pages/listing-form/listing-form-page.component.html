<div class="listing-form-wizard">
  <!-- Progress Bar -->
  <div class="wizard-progress">
    <div class="wizard-progress-bar" [style.width.%]="progressPercentage"></div>
  </div>

  <!-- Stepper Header -->
  <div class="wizard-header">
    <div class="wizard-steps">
      <div *ngFor="let step of steps; let i = index" class="wizard-step" [class.wizard-step--active]="currentStep === i"
        [class.wizard-step--completed]="currentStep > i" (click)="goToStep(i)">
        <div class="wizard-step-circle">
          <span *ngIf="currentStep <= i">{{ i + 1 }}</span>
          <svg *ngIf="currentStep > i" class="wizard-step-check" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
              d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
              clip-rule="evenodd" />
          </svg>
        </div>
        <div class="wizard-step-content">
          <div class="wizard-step-title">{{ step.title }}</div>
          <div class="wizard-step-description">{{ step.description }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Form Content -->
  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="wizard-form">

    <!-- Step 0: Información Básica -->
    <div class="wizard-content" *ngIf="currentStep === 0">
      <h2 class="wizard-content-title">Información Básica</h2>
      <p class="wizard-content-subtitle">Cuéntanos sobre tu propiedad</p>

      <div class="form-group">
        <label class="form-label">Título *</label>
        <input type="text"
               formControlName="title"
               class="form-input"
               [class.form-input--error]="isFieldInvalid('title')"
               placeholder="ej. Hermosa casa en la playa">
        <div *ngIf="isFieldInvalid('title')" class="form-error">
          {{ getFieldError('title') }}
        </div>
        <div *ngIf="!form.get('title')?.errors && form.get('title')?.value" class="form-success">
          ✓ Título válido
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Descripción *</label>
        <textarea formControlName="description"
                  rows="6"
                  class="form-input"
                  [class.form-input--error]="isFieldInvalid('description')"
                  placeholder="Describe tu propiedad, sus características especiales y lo que la hace única..."></textarea>
        <div class="form-character-count">
          {{ form.get('description')?.value?.length || 0 }}/50 caracteres mínimos
        </div>
        <div *ngIf="isFieldInvalid('description')" class="form-error">
          {{ getFieldError('description') }}
        </div>
        <div *ngIf="!form.get('description')?.errors && form.get('description')?.value?.length >= 50" class="form-success">
          ✓ Descripción válida
        </div>
      </div>

      <!-- Resumen de validación del paso -->
      <div *ngIf="showValidationErrors && !isCurrentStepValid()" class="step-validation-summary">
        <div class="validation-error">
          <svg class="validation-error-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          Por favor, completa todos los campos requeridos antes de continuar.
        </div>
      </div>
    </div>

    <!-- Step 1: Categoría -->
    <div class="wizard-content" *ngIf="currentStep === 1">
      <h2 class="wizard-content-title">Tipo de Alojamiento</h2>
      <p class="wizard-content-subtitle">Selecciona el tipo de propiedad y espacio</p>

      <!-- Property Types (Multiple Selection) -->
      <div class="category-section">
        <h3 class="category-section-title">Tipo de Propiedad <span class="badge-optional">(Puedes seleccionar varios)</span></h3>
        <div class="category-grid">
          <div *ngFor="let category of propertyTypes"
               class="category-card"
               [class.category-card--selected]="isCategorySelected(category.id)"
               (click)="toggleCategory(category.id, 'Property Type')">
            <div class="category-icon">
              <app-icon *ngIf="category.icon" [name]="category.icon" [size]="32"></app-icon>
            </div>
            <div class="category-name">{{ category.name }}</div>
            <div class="category-description">{{ category.description }}</div>
            <div class="category-check" *ngIf="isCategorySelected(category.id)">
              <svg fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Space Types (Single Selection) -->
      <div class="category-section">
        <h3 class="category-section-title">Tipo de Espacio <span class="badge-required">*</span> <span class="badge-info">(Solo uno)</span></h3>
        <div class="category-grid">
          <div *ngFor="let category of spaceTypes"
               class="category-card"
               [class.category-card--selected]="isCategorySelected(category.id)"
               (click)="toggleCategory(category.id, 'Space Type')">
            <div class="category-icon">
              <app-icon *ngIf="category.icon" [name]="category.icon" [size]="32"></app-icon>
            </div>
            <div class="category-name">{{ category.name }}</div>
            <div class="category-description">{{ category.description }}</div>
            <div class="category-check" *ngIf="isCategorySelected(category.id)">
              <svg fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="showValidationErrors && categoryIdsArray.length === 0" class="step-validation-summary">
        <div class="validation-error">
          <svg class="validation-error-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          Debes seleccionar al menos un tipo de espacio para continuar.
        </div>
      </div>
    </div>

    <!-- Step 2: Ubicación -->
    <div class="wizard-content" *ngIf="currentStep === 2" formGroupName="location">
      <h2 class="wizard-content-title">Ubicación</h2>
      <p class="wizard-content-subtitle">¿Dónde se encuentra tu propiedad?</p>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Ciudad *</label>
          <input type="text"
                 formControlName="city"
                 class="form-input"
                 [class.form-input--error]="isFieldInvalid('location.city')"
                 placeholder="ej. Malibu">
          <div *ngIf="isFieldInvalid('location.city')" class="form-error">
            {{ getFieldError('location.city') }}
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">País *</label>
          <input type="text"
                 formControlName="country"
                 class="form-input"
                 [class.form-input--error]="isFieldInvalid('location.country')"
                 placeholder="ej. Estados Unidos">
          <div *ngIf="isFieldInvalid('location.country')" class="form-error">
            {{ getFieldError('location.country') }}
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Dirección *</label>
        <input type="text"
               formControlName="address"
               class="form-input"
               [class.form-input--error]="isFieldInvalid('location.address')"
               placeholder="ej. 123 Pacific Coast Highway">
        <div *ngIf="isFieldInvalid('location.address')" class="form-error">
          {{ getFieldError('location.address') }}
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Latitud (opcional)</label>
          <input type="number"
                 formControlName="latitude"
                 step="0.00000001"
                 class="form-input"
                 [class.form-input--error]="isFieldInvalid('location.latitude')"
                 placeholder="ej. 34.0259"
                 min="-90"
                 max="90"
                 lang="en"
                 (blur)="normalizeCoordinateInput('latitude')">
          <div *ngIf="isFieldInvalid('location.latitude')" class="form-error">
            {{ getFieldError('location.latitude') }}
          </div>
          <p class="form-hint-small">Usa punto (.) como separador decimal: ej. 40.4167</p>
        </div>

        <div class="form-group">
          <label class="form-label">Longitud (opcional)</label>
          <input type="number"
                 formControlName="longitude"
                 step="0.00000001"
                 class="form-input"
                 [class.form-input--error]="isFieldInvalid('location.longitude')"
                 placeholder="ej. -118.7798"
                 min="-180"
                 max="180"
                 lang="en"
                 (blur)="normalizeCoordinateInput('longitude')">
          <div *ngIf="isFieldInvalid('location.longitude')" class="form-error">
            {{ getFieldError('location.longitude') }}
          </div>
          <p class="form-hint-small">Usa punto (.) como separador decimal: ej. -3.7037</p>
        </div>
      </div>

      <div *ngIf="showValidationErrors && !isCurrentStepValid()" class="step-validation-summary">
        <div class="validation-error">
          <svg class="validation-error-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          Por favor, completa la información de ubicación requerida.
        </div>
      </div>

      <p class="form-hint">Las coordenadas son opcionales. Se utilizan para ubicar tu propiedad en el mapa.</p>
    </div>

    <!-- Step 3: Detalles -->
    <div class="wizard-content" *ngIf="currentStep === 3">
      <h2 class="wizard-content-title">Detalles de la Propiedad</h2>
      <p class="wizard-content-subtitle">Especifica la capacidad y características</p>

      <div class="form-grid form-grid--3">
        <div class="form-group">
          <label class="form-label">Capacidad (Huéspedes) *</label>
          <input type="number" formControlName="capacity" min="1" class="form-input" placeholder="6">
        </div>

        <div class="form-group">
          <label class="form-label">Habitaciones *</label>
          <input type="number" formControlName="bedrooms" min="0" class="form-input" placeholder="3">
        </div>

        <div class="form-group">
          <label class="form-label">Baños *</label>
          <input type="number" formControlName="bathrooms" min="0" class="form-input" placeholder="2">
        </div>
      </div>
    </div>

    <!-- Step 4: Amenidades -->
    <div class="wizard-content" *ngIf="currentStep === 4">
      <h2 class="wizard-content-title">Amenidades y Servicios</h2>
      <p class="wizard-content-subtitle">¿Qué ofreces a tus huéspedes?</p>

      <div *ngFor="let amenityCategory of amenityCategories" class="amenity-category">
        <h3 class="amenity-category-title">{{ amenityCategory }}</h3>
        <div class="amenity-grid">
          <div *ngFor="let amenity of getAmenitiesByCategory(amenityCategory)"
               class="amenity-item"
               [class.amenity-item--selected]="isAmenitySelected(amenity.id)"
               (click)="toggleAmenity(amenity.id)">
            <div class="amenity-icon">
              <app-icon *ngIf="amenity.icon" [name]="amenity.icon" [size]="24"></app-icon>
            </div>
            <div class="amenity-name">{{ amenity.name }}</div>
            <div class="amenity-check" *ngIf="isAmenitySelected(amenity.id)">
              <svg fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="showValidationErrors && amenityIdsArray.length === 0" class="step-validation-summary">
        <div class="validation-error">
          <svg class="validation-error-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          Selecciona al menos una amenidad para ofrecer a tus huéspedes.
        </div>
      </div>
    </div>

    <div class="wizard-content" *ngIf="currentStep === 5" formGroupName="price">
      <h2 class="wizard-content-title">Precio</h2>
      <p class="wizard-content-subtitle">Establece tu tarifa por noche</p>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Precio por noche *</label>
          <input type="number"
                 formControlName="amount"
                 min="0"
                 step="0.01"
                 class="form-input"
                 [class.form-input--error]="isFieldInvalid('price.amount')"
                 placeholder="350.00">
          <div *ngIf="isFieldInvalid('price.amount')" class="form-error">
            {{ getFieldError('price.amount') }}
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Moneda *</label>
          <select formControlName="currency"
                  class="form-input"
                  [class.form-input--error]="isFieldInvalid('price.currency')">
            <option value="USD">USD - Dólar Estadounidense</option>
            <option value="EUR">EUR - Euro</option>
            <option value="GBP">GBP - Libra Esterlina</option>
          </select>
          <div *ngIf="isFieldInvalid('price.currency')" class="form-error">
            {{ getFieldError('price.currency') }}
          </div>
        </div>
      </div>

      <div *ngIf="showValidationErrors && !isCurrentStepValid()" class="step-validation-summary">
        <div class="validation-error">
          <svg class="validation-error-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          Por favor, establece un precio válido para tu propiedad.
        </div>
      </div>
    </div>

    <!-- Step 6: Fotos -->
    <div class="wizard-content" *ngIf="currentStep === 6">
      <h2 class="wizard-content-title">Fotos</h2>
      <p class="wizard-content-subtitle">Muestra tu propiedad con imágenes atractivas</p>

      <div class="upload-area">
        <label class="upload-label">
          <input type="file" (change)="onFileSelected($event)" accept="image/*" class="upload-input">
          <div class="upload-content">
            <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <span *ngIf="!uploading" class="upload-text">Haz clic para subir una imagen</span>
            <span *ngIf="uploading" class="upload-text upload-text--loading">Subiendo...</span>
          </div>
        </label>
      </div>

      <div class="image-grid" *ngIf="uploadedImages.length > 0">
        <div *ngFor="let img of uploadedImages; let i = index" class="image-item">
          <img [src]="img.url" [alt]="'Imagen ' + (i + 1)" class="image-preview">

          <div class="image-overlay">
            <button type="button" (click)="setPrimaryImage(i)" class="image-button"
              [class.image-button--primary]="img.isPrimary" title="Establecer como principal">
              <svg class="image-icon" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
              </svg>
            </button>
            <button type="button" (click)="removeImage(i)" class="image-button image-button--delete" title="Eliminar">
              <svg class="image-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>

          <div *ngIf="img.isPrimary" class="image-badge">Principal</div>
        </div>
      </div>

      <div *ngIf="showValidationErrors && imagesArray.length === 0" class="step-validation-summary">
        <div class="validation-error">
          <svg class="validation-error-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          Debes subir al menos una foto para mostrar tu propiedad.
        </div>
      </div>

      <div *ngIf="uploadedImages.length > 0" class="upload-success">
        <svg class="upload-success-icon" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>
        ¡Perfecto! Has subido {{ uploadedImages.length }} imagen{{ uploadedImages.length > 1 ? 's' : '' }}.
      </div>
    </div>

    <div class="wizard-actions">
      <button type="button"
              *ngIf="!isFirstStep"
              (click)="previousStep()"
              class="wizard-button wizard-button--secondary">
        <svg class="button-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        Anterior
      </button>

      <div class="wizard-button-spacer"></div>

      <button type="button"
              *ngIf="!isLastStep"
              (click)="nextStep()"
              [disabled]="!canProceedToNextStep()"
              [class.wizard-button--disabled]="!canProceedToNextStep()"
              class="wizard-button wizard-button--primary">
        Siguiente
        <svg class="button-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </button>

      <button type="submit"
              *ngIf="isLastStep"
              [disabled]="!canSubmitForm()"
              [class.wizard-button--disabled]="!canSubmitForm()"
              [class.wizard-button--loading]="isSubmitting"
              class="wizard-button wizard-button--primary">
        <span *ngIf="!isSubmitting">
          {{ isEditMode ? 'Actualizar Listing' : 'Crear Listing' }}
        </span>
        <span *ngIf="isSubmitting" class="loading-content">
          <svg class="loading-spinner" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.3"/>
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" stroke-dasharray="31.416" stroke-dashoffset="31.416" transform="rotate(-90 12 12)"/>
          </svg>
          {{ isEditMode ? 'Actualizando...' : 'Creando...' }}
        </span>
      </button>
    </div>

    <div *ngIf="showValidationErrors && !isCurrentStepValid()" class="form-validation-summary">
      <div class="validation-error-card">
        <svg class="validation-error-icon" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
        <div class="validation-error-content">
          <h4>Por favor, completa los campos requeridos</h4>
          <p>Revisa y corrige los errores destacados antes de continuar.</p>
        </div>
      </div>
    </div>

  </form>
</div>
