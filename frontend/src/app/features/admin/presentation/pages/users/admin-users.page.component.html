<div class="card">
    <header class="cardHeader">
        <h2>Usuarios</h2>
        
        <div class="header-actions">
            <!-- Buscador -->
            <div class="search-box">
                <input 
                    type="text" 
                    [(ngModel)]="searchTerm"
                    (keydown)="onSearchKeydown($event)"
                    placeholder="Buscar por nombre, email o username..."
                    class="search-input" />
                <button 
                    (click)="onSearchClick()"
                    class="search-button"
                    [disabled]="isLoading">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>
            </div>

            <!-- Filtro por rol -->
            <div class="role-filter">
                <select 
                    [(ngModel)]="selectedRoleFilter"
                    (change)="onRoleFilterChange(selectedRoleFilter)"
                    class="filter-select">
                    <option value="">Todos los roles</option>
                    <option *ngFor="let role of roles" [value]="role.name">{{ role.name }}</option>
                </select>
            </div>

            <!-- Botón limpiar filtros -->
            <button 
                *ngIf="searchTerm || selectedRoleFilter"
                (click)="clearFilters()"
                class="btn-clear">
                Limpiar filtros
            </button>
        </div>
    </header>

    <!-- Mensaje de error -->
    <div *ngIf="errorMessage" class="error-message">
        {{ errorMessage }}
    </div>

    <!-- Loading -->
    <div *ngIf="isLoading" class="loading">
        Cargando usuarios...
    </div>

    <table *ngIf="!isLoading && users.length > 0">
        <thead>
            <tr>
                <th>Usuario</th>
                <th>Email</th>
                <th>Roles</th>
                <th style="width: 300px;">Acciones</th>
            </tr>
        </thead>

        <tbody>
            <tr *ngFor="let u of users">
                <td class="user">
                    <img [src]="u.avatar" alt="Avatar" />
                    <div>
                        <strong>{{ u.firstName }} {{ u.lastName }}</strong>
                        <div class="muted">@{{ u.username }}</div>
                    </div>
                </td>

                <td class="muted">{{ u.email }}</td>

                <td>
                    <ng-container *ngFor="let r of u.roles">
                        <span *ngIf="r.name !== 'CLIENT' || u.roles.length === 1"
                              class="badge" 
                              [class.admin]="r.name === 'ADMIN'" 
                              [class.host]="r.name === 'HOST'"
                              [class.client]="r.name === 'CLIENT'">
                            {{ r.name }}
                        </span>
                    </ng-container>
                </td>

                <td class="row-actions">
                    <button class="small" 
                            [class.active-role]="hasRole(u, 'HOST')"
                            (click)="toggleRole(u, 'HOST')">
                        {{ hasRole(u, 'HOST') ? 'Quitar Host' : 'Hacer Host' }}
                    </button>
                    
                    <button class="small danger" 
                            [class.active-role]="hasRole(u, 'ADMIN')"
                            (click)="toggleRole(u, 'ADMIN')">
                        {{ hasRole(u, 'ADMIN') ? 'Quitar Admin' : 'Hacer Admin' }}
                    </button>
                </td>
            </tr>
        </tbody>
    </table>

    <!-- Empty state -->
    <div *ngIf="!isLoading && users.length === 0" class="empty-state">
        <p>No se encontraron usuarios</p>
    </div>

    <!-- Paginación -->
    <div *ngIf="!isLoading && users.length > 0" class="pagination">
        <div class="pagination-info">
            Mostrando {{ (currentPage * pageSize) + 1 }} - {{ Math.min((currentPage + 1) * pageSize, totalElements) }} de {{ totalElements }} usuarios
        </div>
        
        <div class="pagination-controls">
            <button 
                (click)="previousPage()"
                [disabled]="currentPage === 0"
                class="btn-pagination">
                ← Anterior
            </button>
            
            <span class="page-indicator">
                Página {{ currentPage + 1 }} de {{ totalPages }}
            </span>
            
            <button 
                (click)="nextPage()"
                [disabled]="isLastPage"
                class="btn-pagination">
                Siguiente →
            </button>
        </div>
    </div>
</div>