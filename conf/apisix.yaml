
consumers:
  - username: identity-service-issuer
    plugins:
      jwt-auth:
        secret: "NUESTRAKEYTEMPORALUNICAMENTEPARADESARROLLOYNOUSARENPRODUCCION"
        key: "identity-service-key"

upstreams:
  - id: 1
    name: identity-upstream
    type: roundrobin
    nodes:
      "host.docker.internal:5000": 1
  - id: 2
    name: admin-upstream
    type: roundrobin
    nodes:
      "host.docker.internal:5001": 1

  - id: 3
    name: payments-upstream
    type: roundrobin
    nodes:
      "host.docker.internal:5002": 1
  - id: 4
    name: listings-upstream
    type: roundrobin
    nodes:
      "host.docker.internal:5003": 1
    

services:
  - id: 1
    name: identity-service-policies
    upstream_id: 1
    plugins:
      jwt-auth:
        anonymous: true #this allows the token to be absent
        failed_http_status: 403 #if there's a token but it's invalid
      cors:
        allow_origins: "*"
  - id: 2
    name: admin-service-policies
    upstream_id: 2
    plugins:
      jwt-auth:
        anonymous: true #this allows the token to be absent
        failed_http_status: 403 #if there's a token but it's invalid
      cors:
        allow_origins: "*"

  - id: 3
    name: payments-service-policies
    upstream_id: 3
    plugins:
      jwt-auth:
        anonymous: true #this allows the token to be absent
        failed_http_status: 403 #if there's a token but it's invalid
      cors:
        allow_origins: "*"
  - id: 4
    name: listings-service-policies
    upstream_id: 4
    plugins:      
      jwt-auth:
        anonymous: true #this allows the token to be absent
        failed_http_status: 403 #if there's a token but it's invalid
      cors:
        allow_origins: "*"

routes:
  #BASE ROUTE OF CLAIMS
  - id: 1
    name: identity-prefix-router
    uri: /api/identity-service/* 
    methods: ["GET", "POST", "PUT", "DELETE"]
    service_id: 1 
    plugins:
      proxy-rewrite:
        set_headers:
          X-User-ID: $jwt_claim_id
          X-User-Roles: $jwt_claim_roles
        regex_uri: ["(^/api)/identity-service/(.*)", "$1/$2"] 

  - id: 2
    name: admin-prefix-router
    uri: /api/admin-service/*
    methods: ["GET", "POST", "PUT", "DELETE"]
    service_id: 2
    plugins:
      proxy-rewrite:
        #Leading "/" because without it it does not work in django
        regex_uri: ["(^/api)/admin-service/(.*)", "$1/$2/"] 

  - id: 3
    name: payments-prefix-router
    uri: /api/payments-service/*
    methods: ["GET", "POST", "PUT", "DELETE"]
    service_id: 3
    plugins:
      proxy-rewrite:
        #Leading "/" because without it it does not work
        regex_uri: ["(^/api)/payments-service/(.*)", "$1/$2/"]

  - id: 4
    name: listings-prefix-router
    uri: /api/listings-service/*
    methods: ["GET", "POST", "PUT", "DELETE"]
    service_id: 4
    plugins:
      proxy-rewrite:
        regex_uri: ["(^/api)/listings-service/(.*)", "$1/$2"]

#END